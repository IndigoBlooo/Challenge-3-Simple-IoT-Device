#!/bin/bash

import network
import time

#----Network ID Information-----

ssid = "******"
password = "*****"

#-------------------------------

#-----Wi-Fi station interface-----
station = network.WLAN(network.STA_IF)

station.active(True)
station.connect(SSID, PASSWORD)

print ("Attempting to connect to WiFi network:", ssid)

#----- This will check if it is already conntected-------

if not wlan.isconntected():
    wlan.conntect(ssid, password)
    
    max_wait_seconds = 15
    start_time = time.ticks_ms()

    print ("Conntecting", end="")
    while not wlan.isconnected() and time.ticks_diff(time.ticks_ms(), start_time) < max_wait_seconds * 1000:
        print(".", end="")
        time.sleep(1)
    print()

if wlan.isconnected():
    print("WiFi connected successfully!")
    network_config = wlan.ifconfig()
    print("IP address:", network_config[0])

else:
    print("Failed to connect to Wifi.")



#------ LED Pin Setup------- CHANGE THIS PIN LATER!

try
    LED_PIN = 2
    led = machine.Pin(LED_PIN, machine.Pin.OUT)
    led.off()
    print(f"LED initialized on Pin 2)

except Exception as e:
    print(f"Error setting up hardware pin: {e}")

sys.exit()


#---- This is where I will configure MQTT-----

#An indicator incase WiFi is not working
if not wlan.isconnected():

    print("Error: WiFi not connected. Cannot use MQTT.")

else:

# The public test broker

    mqtt_broker = "broker.hivemq.com"


    # This is where the unique client ID will go

    client_id = b"esp32_led_controller_" + machine.unique_id()

# Two topics
    topic_pub = b"wyohack/Madeleine_Wallace/led/command"
    topic_pub = b"wyohack/Madeleine_Wallace/led/status"

#----Callback Function for .../command topic-------

def mqtt_callback(topic, msg):
    message = msg.decode().strip().upper()
    print ("Received:", message)

    if message == "ON":
        led.value(1)
        publish_status("ON")

    elif message == "OFF":
        led.value(0)
        publish_status("OFF")

    else:
        print("Unknown command:", message)

#------ Publishing LED status for the .../status topic------